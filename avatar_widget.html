<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>DYN201 Avatar</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: transparent;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #edf2ff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }

    .avatar-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .avatar {
      width: 230px;
      height: 330px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 0%, #3dedff 0, #0b5ee9 40%, #041632 100%);
      box-shadow: 0 0 40px rgba(0, 255, 255, 0.4);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }

    .avatar-face {
      width: 180px;
      height: 180px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 0%, #192947 0, #050816 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .eyes {
      display: flex;
      gap: 32px;
      margin-bottom: 28px;
    }

    .eye {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      background: #ffffff;
      position: relative;
      overflow: hidden;
      /* Göz kırpma animasyonu */
      transform-origin: center center;
      animation: blink 4s infinite;
    }

    .eye::after {
      content: '';
      position: absolute;
      width: 12px;
      height: 12px;
      border-radius: 999px;
      background: #020617;
      top: 8px;
      left: 8px;
    }

    @keyframes blink {
      0%, 88%, 100% {
        transform: scaleY(1);
      }
      90%, 92% {
        transform: scaleY(0.1);
      }
      94%, 96% {
        transform: scaleY(1);
      }
    }

    .mouth {
      width: 70px;
      height: 30px;
      border-radius: 0 0 40px 40px;
      background: #020617;
      transition: height 0.08s ease;
    }

    .body {
      margin-top: 12px;
      width: 180px;
      height: 120px;
      border-radius: 40px;
      background: linear-gradient(180deg, #22c55e, #059669);
    }

    .subtitle {
      margin-top: 10px;
      font-size: 11.5px;
      text-align: center;
      max-width: 260px;
      color: #cbd5f5;
      line-height: 1.3;
    }

    .btn-row {
      margin-top: 12px;
      display: flex;
      gap: 8px;
    }

    .btn {
      border: none;
      outline: none;
      border-radius: 999px;
      padding: 8px 18px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .btn-play {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #020617;
      box-shadow: 0 0 14px rgba(34, 197, 94, 0.5);
    }

    .btn-stop {
      background: #ef4444;
      color: #f9fafb;
      box-shadow: 0 0 14px rgba(239, 68, 68, 0.45);
    }

    .status {
      margin-top: 6px;
      font-size: 11px;
      color: #94a3b8;
      text-align: center;
      max-width: 260px;
    }
  </style>
</head>
<body>
  <div class="avatar-wrapper">
    <div class="avatar">
      <div class="avatar-face">
        <div class="eyes">
          <div class="eye"></div>
          <div class="eye"></div>
        </div>
        <div class="mouth" id="mouth"></div>
      </div>
      <div class="body"></div>
    </div>

    <div class="subtitle">
      Bu avatar tamamen FREEWARE teknolojilerle çalışır.
      DYN201 sorularını cevaplarken sana eşlik eder.
      Tarayıcı destekliyorsa cevapları Türkçe sesle okuyabilir.
    </div>

    <div class="btn-row">
      <button class="btn btn-play" id="btnPlay">Cevabı sesli okusun</button>
      <button class="btn btn-stop" id="btnStop">Durdur</button>
    </div>

    <div class="status" id="status">
      Son DYN201 cevabını okumak için butona bas.
    </div>
  </div>

  <script>
    const synth = window.speechSynthesis;
    const mouth = document.getElementById("mouth");
    const statusEl = document.getElementById("status");

    let selectedVoice = null;
    let mouthInterval = null;

    // --- AĞIZ ANİMASYONU ---
    function startMouthAnimation() {
      stopMouthAnimation(); // eski interval varsa temizle
      let open = false;
      mouthInterval = setInterval(() => {
        mouth.style.height = open ? "30px" : "50px";
        open = !open;
      }, 120);
    }

    function stopMouthAnimation() {
      if (mouthInterval) {
        clearInterval(mouthInterval);
        mouthInterval = null;
      }
      mouth.style.height = "30px";
    }

    // --- 1) Türkçe, mümkünse erkek sese yaklaş ---
    function pickTurkishVoice() {
      const voices = synth.getVoices();
      if (!voices || !voices.length) return;

      const turkishVoices = voices.filter(v =>
        v.lang && v.lang.toLowerCase().startsWith("tr")
      );

      const maleLike = turkishVoices.find(v =>
        /tolga|ahmet|microsoft|male|erkek|natural/i.test(v.name)
      );

      const googleTr = turkishVoices.find(v =>
        /google/i.test(v.name)
      );

      selectedVoice = maleLike || googleTr || turkishVoices[0] || null;

      if (selectedVoice) {
        console.log("Seçilen ses:", selectedVoice.name, selectedVoice.lang);
        statusEl.textContent =
          `Ses hazır: ${selectedVoice.name} (${selectedVoice.lang}). Son DYN201 cevabını okumak için butona bas.`;
      } else {
        statusEl.textContent =
          "Türkçe ses bulunamadı, varsayılan ses ile okuyacağım.";
      }
    }

    if (typeof synth.onvoiceschanged !== "undefined") {
      synth.onvoiceschanged = pickTurkishVoice;
    }
    pickTurkishVoice();

    // --- 2) Son asistan mesajını DOM'dan çek (ilk selamı hariç tut) ---
    function getLastAssistantMessage() {
      const GREETING_PREFIX =
        "merhaba, ben dyn201 avatar eğitmeninim";

      try {
        const rootDoc = window.parent.document;
        const msgs = rootDoc.querySelectorAll('div[data-testid="stChatMessage"]');
        if (!msgs.length) {
          return "Şu anda okunacak bir DYN201 cevabı bulamadım.";
        }

        // Sondan başa doğru tara; ilk selam dışındaki dolu metni al
        for (let i = msgs.length - 1; i >= 0; i--) {
          const el = msgs[i];
          const md = el.querySelector('[data-testid="stMarkdown"]');
          let text = (md ? md.innerText : el.innerText || "").trim();
          if (!text) continue;

          text = text.replace(/\s+/g, " ");

          const lower = text.toLowerCase();
          if (lower.startsWith(GREETING_PREFIX)) {
            // İlk sabit selamı atla
            continue;
          }

          return text;
        }

        return "Şu anda okunacak bir DYN201 cevabı bulamadım.";
      } catch (e) {
        console.error("Son mesaj okunamadı:", e);
        return "Tarayıcı kısıtlaması nedeniyle son cevabı okuyamıyorum.";
      }
    }

    // --- 3) Konuşmayı başlat ---
    function startTalking(text) {
      if (!("speechSynthesis" in window)) {
        statusEl.textContent = "Tarayıcı metin okuma özelliğini desteklemiyor.";
        return;
      }

      synth.cancel();
      stopMouthAnimation();

      const utter = new SpeechSynthesisUtterance(text);

      if (selectedVoice) {
        utter.voice = selectedVoice;
        utter.lang = selectedVoice.lang;
      } else {
        utter.lang = "tr-TR";
      }

      // Hafif yavaş, hafif tok
      utter.rate  = 0.93;
      utter.pitch = 0.9;
      utter.volume = 1.0;

      utter.onstart = () => {
        startMouthAnimation();
        statusEl.textContent = "Cevap sesli olarak okunuyor...";
      };

      utter.onend = () => {
        stopMouthAnimation();
        statusEl.textContent =
          "Okuma bitti. Son cevabı tekrar dinlemek için butona bas.";
      };

      utter.onerror = (e) => {
        console.error("TTS error:", e);
        stopMouthAnimation();
        statusEl.textContent = "Okuma sırasında bir hata oluştu.";
      };

      synth.speak(utter);
    }

    // --- 4) Durdur ---
    function stopTalking() {
      if ("speechSynthesis" in window) {
        synth.cancel();
      }
      stopMouthAnimation();
      statusEl.textContent = "Okuma durduruldu. Tekrar dinlemek için butona bas.";
    }

    document.getElementById("btnPlay").addEventListener("click", () => {
      const text = getLastAssistantMessage();
      startTalking(text);
    });

    document.getElementById("btnStop").addEventListener("click", () => {
      stopTalking();
    });
  </script>
</body>
</html>
