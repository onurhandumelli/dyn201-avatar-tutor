<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>DYN201 Avatar</title>
  <style>
    body {
      margin: 0;
      padding: 10px;
      background: #050814;
      color: #f5f5f5;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    .avatar-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      height: 400px;
    }

    .head {
      width: 190px;
      height: 210px;
      background: radial-gradient(circle at 30% 20%, #3bd9ff 0, #131b33 40%, #050814 100%);
      border-radius: 50% 50% 45% 45%;
      position: relative;
      box-shadow: 0 0 25px rgba(0, 255, 255, 0.3);
    }

    .eye {
      width: 30px;
      height: 18px;
      background: #f5f5f5;
      border-radius: 50px;
      position: absolute;
      top: 70px;
      overflow: hidden;
    }

    .eye.left { left: 45px; }
    .eye.right { right: 45px; }

    .pupil {
      width: 12px;
      height: 12px;
      background: #111;
      border-radius: 50%;
      position: absolute;
      top: 3px;
      left: 9px;
    }

    .mouth {
      width: 82px;
      height: 18px;
      background: #111;
      border-radius: 0 0 50px 50px;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: 40px;
      transition: height 0.12s ease, transform 0.12s ease, background 0.12s ease;
    }

    .mouth.talking {
      height: 36px;
      transform: translateX(-50%) translateY(6px);
      background: #b32a4a;
    }

    .torso {
      width: 145px;
      height: 95px;
      background: linear-gradient(180deg, #1abf79, #0f6b45);
      border-radius: 30px;
      margin-top: -12px;
      box-shadow: 0 0 18px rgba(0, 255, 165, 0.28);
    }

    .btn-row {
      display: flex;
      gap: 8px;
      margin-top: 18px;
    }

    .btn {
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      background: #26a69a;
      color: white;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 0 10px rgba(0, 255, 165, 0.3);
      font-size: 12px;
      white-space: nowrap;
    }

    .btn:hover {
      background: #1f8f82;
    }

    .btn.stop {
      background: #e53935;
      box-shadow: 0 0 10px rgba(255, 82, 82, 0.35);
    }

    .btn.stop:hover {
      background: #c62828;
    }

    .hint {
      margin-top: 10px;
      font-size: 11px;
      opacity: 0.85;
      text-align: center;
      max-width: 260px;
    }
  </style>
</head>
<body>
  <div class="avatar-wrapper">
    <div class="head">
      <div class="eye left">
        <div class="pupil"></div>
      </div>
      <div class="eye right">
        <div class="pupil"></div>
      </div>
      <div id="mouth" class="mouth"></div>
    </div>
    <div class="torso"></div>

    <div class="btn-row">
      <button id="speakBtn" class="btn">CevabÄ± sesli okusun</button>
      <button id="stopBtn" class="btn stop">Durdur</button>
    </div>

    <div class="hint">
      Bu avatar tamamen FREEWARE teknolojilerle yapÄ±ldÄ±.<br />
      Gemini cevabÄ±nÄ± tarayÄ±cÄ±daki TÃ¼rkÃ§e sesle okuyor ve konuÅŸma sÄ±rasÄ±nda animasyon yapÄ±yor.
    </div>
  </div>

  <script>
    // Python tarafÄ± burayÄ± son cevapla dolduruyor
    const answerText = `{{ANSWER_PLACEHOLDER}}`;

    const mouth = document.getElementById("mouth");
    const speakBtn = document.getElementById("speakBtn");
    const stopBtn = document.getElementById("stopBtn");

    let talkingInterval = null;
    let voices = [];

    function loadVoices() {
      voices = window.speechSynthesis.getVoices() || [];
    }

    window.speechSynthesis.onvoiceschanged = loadVoices;
    loadVoices();

    function pickTurkishVoice() {
      if (!voices.length) return null;
      // Dil kodunda "tr" geÃ§en sesi bulmaya Ã§alÄ±ÅŸ
      return (
        voices.find(v => v.lang && v.lang.toLowerCase().startsWith("tr")) ||
        voices.find(v => v.lang && v.lang.toLowerCase().includes("tr")) ||
        null
      );
    }

    function startMouthAnimation() {
      if (talkingInterval) return;
      talkingInterval = setInterval(() => {
        mouth.classList.toggle("talking");
      }, 120);
    }

    function stopMouthAnimation() {
      if (talkingInterval) {
        clearInterval(talkingInterval);
        talkingInterval = null;
      }
      mouth.classList.remove("talking");
    }

    function speak(text) {
      if (!("speechSynthesis" in window)) {
        alert("TarayÄ±cÄ±nda speechSynthesis desteÄŸi yok (Chrome / Edge dene).");
        return;
      }
      if (!text || text.trim().length === 0) {
        alert("Ã–nce chat bÃ¶lÃ¼mÃ¼nde bir soru sor ve asistanÄ±n cevap vermesini bekle.");
        return;
      }

      // Eski konuÅŸmalarÄ± ve animasyonu durdur
      window.speechSynthesis.cancel();
      stopMouthAnimation();

      const utter = new SpeechSynthesisUtterance(text);

      const trVoice = pickTurkishVoice();
      if (trVoice) {
        utter.voice = trVoice;
        utter.lang = trVoice.lang;
      } else {
        // Ses listesinde TÃ¼rkÃ§e yoksa en azÄ±ndan dil kodunu TR yap
        utter.lang = "tr-TR";
      }

      utter.rate = 1.0;

      utter.onstart = () => {
        startMouthAnimation();
      };

      utter.onend = () => {
        stopMouthAnimation();
      };

      window.speechSynthesis.speak(utter);
    }

    function stopSpeaking() {
      if (!("speechSynthesis" in window)) return;
      window.speechSynthesis.cancel();
      stopMouthAnimation();
    }

    speakBtn.addEventListener("click", () => {
      speak(answerText);
    });

    stopBtn.addEventListener("click", () => {
      stopSpeaking();
    });

    // Sayfa her yÃ¼klendiÄŸinde varsa Ã¶nceki konuÅŸmayÄ± kes
    window.addEventListener("load", () => {
      stopSpeaking();
    });
  </script>
 <!-- MÄ°KROFON BUTONU VE WEB SPEECH API -->
<div style="margin-top: 16px; text-align: center;">
  <button id="mic-btn"
          style="padding: 8px 16px; border-radius: 999px; border: none;
                 background-color: #00b894; color: white; font-weight: bold; cursor: pointer;">
    ðŸŽ¤ KonuÅŸmayÄ± BaÅŸlat / Durdur
  </button>
  <p id="mic-status" style="color: #cccccc; font-size: 12px; margin-top: 8px;"></p>
</div>

<script>
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

  if (SpeechRecognition) {
    const recog = new SpeechRecognition();
    recog.lang = "tr-TR";
    recog.continuous = false;
    recog.interimResults = false;

    const btn = document.getElementById("mic-btn");
    const status = document.getElementById("mic-status");

    let listening = false;

    btn.onclick = function() {
      if (!listening) {
        recog.start();
        listening = true;
        status.textContent = "Dinliyorum...";
      } else {
        recog.stop();
        listening = false;
        status.textContent = "Durduruldu.";
      }
    };

    recog.onresult = function(event) {
      const text = event.results[0][0].transcript;
      status.textContent = "AlgÄ±lanan: " + text;

      // Streamlit uygulamasÄ±na gÃ¶nder
      window.parent.postMessage(
        { type: "dyn201_voice_input", text: text },
        "*"
      );
    };

    recog.onerror = function(e) {
      status.textContent = "Ses tanÄ±ma hatasÄ±: " + e.error;
      listening = false;
    };
  } else {
    const status = document.getElementById("mic-status");
    if (status) {
      status.textContent = "TarayÄ±cÄ± Web Speech API (ses tanÄ±ma) desteklemiyor.";
    }
  }
</script>
 
</body>
</html>
