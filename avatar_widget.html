<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>DYN201 Avatar</title>
  <style>
    /* Temel Ayarlar */
    body {
      margin: 0;
      padding: 0;
      background: transparent;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      color: #edf2ff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      user-select: none; /* Metin se√ßimini engelle */
    }

    .avatar-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 20px;
    }

    /* Avatar Tasarƒ±mƒ± */
    .avatar {
      width: 200px; /* Biraz daha kompakt */
      height: 280px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 0%, #3dedff 0, #0b5ee9 40%, #041632 100%);
      box-shadow: 0 0 50px rgba(11, 94, 233, 0.6); /* Daha belirgin glow */
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      transition: transform 0.3s ease;
    }

    .avatar:hover {
      transform: scale(1.02);
    }

    .avatar-face {
      width: 160px;
      height: 160px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 0%, #192947 0, #050816 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      z-index: 2;
    }

    .eyes {
      display: flex;
      gap: 28px;
      margin-bottom: 24px;
    }

    .eye {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #ffffff;
      position: relative;
      animation: blink 4s infinite; /* G√∂z kƒ±rpma efekti */
    }

    .eye::after {
      content: '';
      position: absolute;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #020617;
      top: 7px;
      left: 7px;
    }

    /* G√∂z kƒ±rpma animasyonu */
    @keyframes blink {
      0%, 48%, 52%, 100% { transform: scaleY(1); }
      50% { transform: scaleY(0.1); }
    }

    .mouth {
      width: 60px;
      height: 10px; /* Ba≈ülangƒ±√ßta kapalƒ± */
      border-radius: 20px;
      background: #020617;
      transition: height 0.1s ease-in-out; /* Hƒ±zlƒ± tepki i√ßin */
    }

    .body {
      margin-top: -20px;
      width: 160px;
      height: 100px;
      border-radius: 40px;
      background: linear-gradient(180deg, #22c55e, #059669);
      z-index: 1;
    }

    /* UI Elemanlarƒ± */
    .subtitle {
      margin-top: 15px;
      font-size: 12px;
      text-align: center;
      max-width: 280px;
      color: #cbd5f5;
      line-height: 1.4;
      font-weight: 500;
    }

    .btn-row {
      margin-top: 15px;
      display: flex;
      gap: 10px;
    }

    .btn {
      border: none;
      outline: none;
      border-radius: 8px;
      padding: 10px 20px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn:active {
      transform: scale(0.95);
    }

    .btn-play {
      background: #22c55e;
      color: #020617;
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4);
    }
    .btn-play:hover { background: #16a34a; }

    .btn-stop {
      background: #ef4444;
      color: #fff;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
    }
    .btn-stop:hover { background: #dc2626; }

    .status {
      margin-top: 10px;
      font-size: 11px;
      color: #94a3b8;
      text-align: center;
      min-height: 20px;
    }
  </style>
</head>
<body>

  <div class="avatar-wrapper">
    <div class="avatar">
      <div class="avatar-face">
        <div class="eyes">
          <div class="eye"></div>
          <div class="eye"></div>
        </div>
        <div class="mouth" id="mouth"></div>
      </div>
      <div class="body"></div>
    </div>

    <div class="subtitle">
      DYN201 Asistanƒ±<br>
      Son cevabƒ± dinlemek i√ßin butona bas.
    </div>

    <div class="btn-row">
      <button class="btn btn-play" id="btnPlay">üîä Oku</button>
      <button class="btn btn-stop" id="btnStop">‚èπ Durdur</button>
    </div>

    <div class="status" id="status">Hazƒ±r.</div>
  </div>

  <script>
    const synth = window.speechSynthesis;
    const mouth = document.getElementById("mouth");
    const statusEl = document.getElementById("status");
    let speakingInterval = null;

    // T√ºrk√ße sesi bulmaya √ßalƒ±≈üan yardƒ±mcƒ± fonksiyon
    function getTurkishVoice() {
      const voices = synth.getVoices();
      // √ñncelik: Google T√ºrk√ße, Microsoft T√ºrk√ße, herhangi bir 'tr' sesi
      return voices.find(v => v.lang === 'tr-TR' && v.name.includes('Google')) ||
             voices.find(v => v.lang === 'tr-TR') ||
             null;
    }

    // Sesler bazen ge√ß y√ºklenir, onvoiceschanged ile tetikleyelim
    if (speechSynthesis.onvoiceschanged !== undefined) {
      speechSynthesis.onvoiceschanged = getTurkishVoice;
    }

    function animateMouth(isTalking) {
      if (speakingInterval) clearInterval(speakingInterval);
      
      if (isTalking) {
        // Konu≈üurken aƒüzƒ± rastgele a√ßƒ±p kapat
        speakingInterval = setInterval(() => {
          const height = Math.floor(Math.random() * 30) + 10; // 10px ile 40px arasƒ±
          mouth.style.height = height + "px";
        }, 150);
      } else {
        // Durduƒüunda aƒüzƒ± kapat
        mouth.style.height = "10px";
      }
    }

    function getLastAssistantMessage() {
      try {
        // Streamlit iframe'inden parent'a eri≈ümeye √ßalƒ±≈üƒ±yoruz
        const rootDoc = window.parent.document;
        
        // Streamlit'in chat mesajƒ± class yapƒ±larƒ± (versiyona g√∂re deƒüi≈üebilir, en yaygƒ±n olanlar)
        // Genelde: stChatMessage user / assistant
        const msgs = rootDoc.querySelectorAll('div[data-testid="stChatMessage"]');
        
        if (!msgs.length) {
          console.warn("Mesaj elementi bulunamadƒ±.");
          return null;
        }

        // Son mesajƒ± al
        const lastMsg = msgs[msgs.length - 1];
        
        // Sadece metni √ßek
        const text = lastMsg.innerText || lastMsg.textContent;
        return text ? text.trim() : null;

      } catch (e) {
        console.error("Eri≈üim hatasƒ± (Cross-Origin):", e);
        statusEl.textContent = "‚ö† Sayfa i√ßeriƒüine eri≈üim engellendi.";
        return null;
      }
    }

    function startTalking(text) {
      if (!text) {
        statusEl.textContent = "Okunacak metin bulunamadƒ±.";
        return;
      }

      // Varsa eski konu≈ümayƒ± iptal et
      if (synth.speaking) synth.cancel();

      const utter = new SpeechSynthesisUtterance(text);
      const trVoice = getTurkishVoice();
      
      if (trVoice) utter.voice = trVoice;
      utter.lang = "tr-TR";
      utter.rate = 1.0; // Hƒ±z
      utter.pitch = 1.0; // Ton

      utter.onstart = () => {
        statusEl.textContent = "Seslendiriliyor...";
        animateMouth(true);
      };

      utter.onend = () => {
        statusEl.textContent = "Okuma tamamlandƒ±.";
        animateMouth(false);
      };

      utter.onerror = (e) => {
        console.error("Ses hatasƒ±:", e);
        statusEl.textContent = "Ses motorunda hata olu≈ütu.";
        animateMouth(false);
      };

      synth.speak(utter);
    }

    document.getElementById("btnPlay").addEventListener("click", () => {
      const text = getLastAssistantMessage();
      
      if (text) {
        startTalking(text);
      } else {
        // Eƒüer parent'a eri≈üemiyorsak kullanƒ±cƒ±ya test ama√ßlƒ± bir mesaj okutalƒ±m
        // ki kodun √ßalƒ±≈ütƒ±ƒüƒ±nƒ± anlasƒ±n.
        if(statusEl.textContent.includes("eri≈üim engellendi")) {
           startTalking("G√ºvenlik nedeniyle ekrandaki yazƒ±yƒ± okuyamƒ±yorum ama ses sistemim √ßalƒ±≈üƒ±yor Efe.");
        } else {
           statusEl.textContent = "Hen√ºz bir mesaj yok.";
        }
      }
    });

    document.getElementById("btnStop").addEventListener("click", () => {
      synth.cancel();
      animateMouth(false);
      statusEl.textContent = "Durduruldu.";
    });
  </script>
</body>
</html>
