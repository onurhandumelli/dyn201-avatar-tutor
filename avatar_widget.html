<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>DYN201 Avatar</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: transparent;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #ffffff;
    }

    .container {
      width: 260px;
      margin: 0 auto;
      text-align: center;
    }

    .avatar-wrapper {
      margin-top: 8px;
      margin-bottom: 8px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .avatar {
      position: relative;
      width: 190px;
      height: 260px;
      background: radial-gradient(circle at 30% 0%, #4fd5ff 0, #1e2b4a 45%, #050712 100%);
      border-radius: 110px 110px 40px 40px;
      box-shadow: 0 0 25px rgba(0, 255, 255, 0.25);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding-top: 34px;
    }

    /* BaÅŸ */
    .head {
      width: 140px;
      height: 140px;
      background: radial-gradient(circle at 30% 0%, #49c7ff 0, #142038 45%, #050712 100%);
      border-radius: 50%;
      position: relative;
      box-shadow: 0 0 18px rgba(0, 255, 255, 0.4);
      animation: glow 4s ease-in-out infinite;
    }

    @keyframes glow {
      0%, 100% { box-shadow: 0 0 18px rgba(0, 255, 255, 0.3); }
      50% { box-shadow: 0 0 30px rgba(0, 255, 255, 0.7); }
    }

    .eye {
      position: absolute;
      top: 45px;
      width: 16px;
      height: 16px;
      background: #ffffff;
      border-radius: 50%;
      box-shadow: 0 0 4px rgba(0,0,0,0.3);
    }

    .eye.left {
      left: 35px;
    }
    .eye.right {
      right: 35px;
    }

    .pupil {
      position: absolute;
      top: 4px;
      left: 5px;
      width: 6px;
      height: 6px;
      background: #000000;
      border-radius: 50%;
      animation: pupil-move 5s ease-in-out infinite;
    }

    @keyframes pupil-move {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(2px); }
      50% { transform: translateX(-2px); }
      75% { transform: translateX(0); }
    }

    .mouth {
      position: absolute;
      bottom: 34px;
      left: 50%;
      transform: translateX(-50%);
      width: 54px;
      height: 18px;
      background: #02050e;
      border-radius: 0 0 26px 26px;
      overflow: hidden;
    }

    .mouth-inner {
      width: 100%;
      height: 100%;
      background: #02050e;
      border-radius: 0 0 26px 26px;
      transform-origin: top;
      animation: talk 2.2s ease-in-out infinite;
    }

    @keyframes talk {
      0%, 30%, 100% { transform: scaleY(0.35); }
      10%, 20% { transform: scaleY(1.0); }
      40%, 50% { transform: scaleY(0.2); }
      60%, 70% { transform: scaleY(0.8); }
      80%, 90% { transform: scaleY(0.3); }
    }

    /* GÃ¶vde */
    .body-shape {
      margin-top: 12px;
      width: 140px;
      height: 80px;
      background: linear-gradient(180deg, #19d29b, #0e8a63);
      border-radius: 36px;
      box-shadow: 0 0 18px rgba(0, 255, 170, 0.3);
    }

    .text-block {
      font-size: 11px;
      line-height: 1.4;
      color: #b8c2ff;
      margin-top: 10px;
    }

    .tts-note {
      font-size: 10px;
      color: #8e99d8;
      margin-top: 4px;
    }

    /* Mikrofon butonu */
    .mic-btn {
      margin-top: 14px;
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #00b894, #00cec9);
      color: white;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.35);
      transition: transform 0.1s ease, box-shadow 0.1s ease, opacity 0.15s ease;
    }
    .mic-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 14px rgba(0,0,0,0.4);
      opacity: 0.96;
    }
    .mic-btn:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.45);
    }

    .mic-status {
      font-size: 11px;
      color: #cfd2ff;
      margin-top: 6px;
      min-height: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="avatar-wrapper">
      <div class="avatar">
        <div class="head">
          <div class="eye left">
            <div class="pupil"></div>
          </div>
          <div class="eye right">
            <div class="pupil"></div>
          </div>
          <div class="mouth">
            <div class="mouth-inner"></div>
          </div>
        </div>
        <div class="body-shape"></div>
      </div>
    </div>

    <div class="text-block">
      Bu avatar tamamen FREEWARE teknolojilerle Ã§alÄ±ÅŸÄ±r.
      DYN201 sorularÄ±nÄ± cevaplarken sana eÅŸlik eder.
    </div>
    <div class="tts-note">
      TarayÄ±cÄ± destekliyorsa, cevaplarÄ±nÄ± TÃ¼rkÃ§e sesle okuyabilir
      ve sesli sorularÄ±nÄ± dinleyebilir.
    </div>

    <!-- Mikrofon butonu -->
    <button id="mic-btn" class="mic-btn">
      ðŸŽ¤ KonuÅŸmayÄ± BaÅŸlat / Durdur
    </button>
    <div id="mic-status" class="mic-status"></div>
  </div>

  <!-- JAVASCRIPT: Ses tanÄ±ma + TTS entegrasyonu -->
  <script>
    // -----------------------------
    // 1) S E S   T A N I M A  (STT)
    // -----------------------------
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    if (SpeechRecognition) {
      const recog = new SpeechRecognition();
      recog.lang = "tr-TR";
      recog.continuous = false;
      recog.interimResults = false;

      const btn = document.getElementById("mic-btn");
      const status = document.getElementById("mic-status");

      let listening = false;

      btn.onclick = function () {
        if (!listening) {
          try {
            recog.start();
            listening = true;
            status.textContent = "Dinliyorum...";
          } catch (e) {
            status.textContent = "Ses tanÄ±ma baÅŸlatÄ±lamadÄ±.";
          }
        } else {
          recog.stop();
          listening = false;
          status.textContent = "Durduruldu.";
        }
      };

      recog.onresult = function (event) {
        const text = event.results[0][0].transcript;
        status.textContent = "AlgÄ±lanan: " + text;

        // Bu metni Streamlit uygulamasÄ±na gÃ¶nder
        try {
          window.parent.postMessage(
            { type: "dyn201_voice_input", text: text },
            "*"
          );
        } catch (e) {
          console.warn("postMessage gÃ¶nderilemedi:", e);
        }
      };

      recog.onerror = function (e) {
        status.textContent = "Ses tanÄ±ma hatasÄ±: " + e.error;
        listening = false;
      };

      recog.onend = function () {
        // KullanÄ±cÄ± konuÅŸmayÄ± bitirdiÄŸinde otomatik kapanma
        listening = false;
        if (status.textContent === "Dinliyorum...") {
          status.textContent = "Dinleme tamamlandÄ±.";
        }
      };
    } else {
      const status = document.getElementById("mic-status");
      if (status) {
        status.textContent = "TarayÄ±cÄ± Web Speech API (ses tanÄ±ma) desteklemiyor.";
      }
    }

    // -----------------------------
    // 2) T E K S T   T O   S P E E C H
    // -----------------------------
    function speakTurkish(text) {
      if (!("speechSynthesis" in window)) {
        console.warn("TarayÄ±cÄ± speechSynthesis desteklemiyor.");
        return;
      }

      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = "tr-TR";

      // MÃ¼mkÃ¼nse TÃ¼rkÃ§e bir ses seÃ§
      const voices = window.speechSynthesis.getVoices();
      const trVoice =
        voices.find(v => v.lang.toLowerCase().startsWith("tr")) ||
        voices.find(v => v.lang.toLowerCase().startsWith("en")) ||
        null;
      if (trVoice) {
        utter.voice = trVoice;
      }

      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utter);
    }

    // Parent (Streamlit) tarafÄ±ndan TTS iÃ§in mesaj gelirse dinle
    window.addEventListener("message", (event) => {
      const data = event.data;
      if (!data || typeof data !== "object") return;

      if (data.type === "dyn201_tts" && typeof data.text === "string") {
        speakTurkish(data.text);
      }
    });
  </script>
</body>
</html>
